<header class="mb-3">
  <div class="d-flex flex-row heading">
    <strong class="heading-title">
      <span class="fa fa-angle-left" style="width: 11px;padding:10px 10px 10px 0;font-size: 18px;cursor: pointer;"
         (click)="viewChanged$.emit('table')"></span>
      {{_selectedIntent?.name || 'Create intent'}}
    </strong>
    <div class="mr-auto"></div>
    <button
      (click)="saveOrUpdateIntent()"
      style="color: white"
      *appMyIf="myEAllActions['Update intent']"
      class="mat-theme-button btn-theme-primary mr-1"
      mat-button
      [disabled]="!isEntityValid"
    >
      <mat-icon>save</mat-icon>
      Save
    </button>
    <button
      *ngIf="!_selectedIntent || !_selectedIntent.intent_id"
      style="border: 1px solid #e0e0e0 !important;"
      (click)="viewChanged$.emit('table')"
      class="mat-theme-button mat-theme-button-border" mat-button>
      <mat-icon>clear</mat-icon>
      Cancel
    </button>
    <ng-container *appMyIf="myEAllActions['Remove intent']">
      <button
        *ngIf="_selectedIntent && _selectedIntent.intent_id"
        style="border: 1px solid #e0e0e0 !important;"
        (click)="deleteIntent$.emit(_selectedIntent)"
        class="mat-theme-button mat-theme-button-border" mat-button>
        <mat-icon>delete</mat-icon>
        Delete
      </button>
    </ng-container>
  </div>
  <div style="color: #696969;font-size: 11px; margin-right: 10px">
    Add new utterances which determine the intent, link entities which can be recognized in the intent and configure
    template keys which will be triggered for required entities and when the intent is completed
  </div>
</header>

<form [formGroup]="form" *ngIf="entityList">
  <div>
    <mat-form-field>
      <input matInput placeholder="Intent name*" formControlName="name">
      <mat-error class="mat-error-small" *ngIf="form.get('name').errors?.error as errorObj">{{errorObj.message}}</mat-error>
    </mat-form-field>
  </div>

  <div *ngIf="view === 'detail'" style="display: flex">
    <div #questionListContainer class="questions-list px-2" style="width: 50%;">
      <div class="questions-heading">All utterances</div>
      <form #questionForm="ngForm" class="addQuestionPanel px-4 pb-2">
        <mat-form-field [attr.dir]="this.bot?.language === 'ar' ? 'rtl' : 'ltr'" floatLabel="never">
          <input matInput type="text" placeholder="Add utterance" ngModel name="questionText"
                 data-cy="add-question-ti-tentemplate"
          />
        </mat-form-field>
        <div class="mat-error-small m-0"
             style="margin-top: -14px !important;
    margin-bottom: 10px !important;"
             *ngIf="(questionForm.value?.questionText|validationPipe:{start_with_alphanumeric: true, max: 64})?.error as errorObj">
          {{errorObj.message}}</div>
        <button class="mat-theme-button cursor-pointer mr-2" type="submit" mat-button
                [disabled]="!questionForm.value.questionText"
                style="border: 1px solid #e0e0e0;padding: 0 8px; border-radius: 2px; width: max-content;"
                (click)="addNewUtterance(questionForm);">
          <span class="fa fa-spin fa-spinner" *ngIf="showEntityMarkingLoader"></span>
          <span class="fa fa-plus" style="font-size: 11px; margin-right: 5px" *ngIf="!showEntityMarkingLoader"></span>
          Add utterance
        </button>
      </form>
      <div *ngIf="!_selectedIntent ||  !(_selectedIntent.utterances) ||_selectedIntent.utterances.length === 0"
           class="no-question"
           [ngClass]="{'text-danger': showError}"
      >
        No utterances added yet, add now to train the intent
      </div>

      <div class="utter-wrapper" style="overflow-y: auto;height: 40vh;" *ngIf="_selectedIntent"
           (keypress)="preventTypingInMarkers($event)">
        <div
          style="position: relative"
          *ngFor="let question of _selectedIntent.utterances; let index = index;">
          <div class="utter"
               appEntityMarking="yellow"
               [intent]="_selectedIntent"
               [entityList]="entityList"
               [utter]="_selectedIntent.utterances[index].utterance"
               [innerHTML]="_selectedIntent.utterances[index].utterance| utteranceAddEntity:_selectedIntent.utterances[index].entities |safeHtml"
               (showCreateNewIntentModel$)="showCreateNewIntentModel$.emit($event)"
               >
          </div>
          <span class="fa fa-trash" *ngIf="_selectedIntent.utterances.length !== 1" (click)="removeUtterance(index)"></span>
        </div>
      </div>

    </div>

    <div style="width: 50%">
      <app-ml-intent-utterance
        (updateResponse$)="updateResponse($event)"
        (linkEntity$)="linkEntityHandler($event)"
        [bot]="bot"
        [keys]="keys"
        (removeEntity$)="removeEntityHandler($event)"
        (formValidity$)="isEntityValid = $event"
        [entityList]="entityList"
        [selectedIntent]="_selectedIntent"
        style="display: block; margin-bottom: 28px"></app-ml-intent-utterance>
      <app-ml-intent-response (updateResponse$)="updateResponse($event)" [bot]="bot" [keys]="keys" [form]="form"></app-ml-intent-response>
    </div>
  </div>
</form>

<ng-template #tpl let-close="close">
  And here's some amazing content. It's very engaging. Right?
  <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
    <a class="button is-danger is-small" (click)="close({id: 2})">Close</a>
  </div>
</ng-template>
