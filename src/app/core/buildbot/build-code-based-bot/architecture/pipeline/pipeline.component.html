<section class="pipeline-section" *ngIf="pipelineModulesV2List">
    <header>
        <div class="hide-phone">Select the modules to add in the bot intelligence pipeline and save to update the pipeline</div>
        <!--<button mat-flat-button style="margin-left: auto" class="mat-theme-button" color="primary" (click)="updateBot()">Update Pipeline</button>-->
      <app-button-wrapper (btnClick)="updateBot()"
                          [status]="updateBotStatus"
                          [toolTipText]="updateBotStatusText"
                          [text]="'Update Pipeline'" style="margin-left: auto"></app-button-wrapper>
    </header>
    <div class="pipeline-section-body hide-phone" style="overflow-y: auto">
        <div class="pipeline-section-body__header">
            <strong>Modules ({{pipelineModulesV2List.length}})</strong>
            <div class="d-inline-flex align-items-center ml-auto mr-3 cursor-pointer"
                 (click)="toggleExpandAllModules()">
                <span class="mr-1" style="font-size: 11px">{{allMatExpansionExpanded ? 'Collapse' : 'Expand'}}
                    All</span>
                <i style="align-items: baseline;font-size: 9px" class="fa"
                   [ngClass]="{'fa-chevron-down':!allMatExpansionExpanded, 'fa-chevron-up':allMatExpansionExpanded}"></i>
            </div>

            <mat-form-field class="hide-phone" style="margin-bottom: -3px" floatLabel="never">
                <input matInput placeholder="Libraries and Modules" [(ngModel)]="searchKeyword">
                <button mat-button matSuffix mat-icon-button aria-label="Clear">
                    <mat-icon>search</mat-icon>
                </button>
            </mat-form-field>
        </div>

        <div class="pipeline-section-body__modules">
            <app-accordian
                    *ngFor="let pipelineItem of pipelineModulesV2List|pipelineFilter:searchKeyword|sortPipeline; let i = index"
                    (click)="togglePipelineModule(pipelineItem.id)"
                    [doExpand]="_expandedPipelineModules[pipelineItem.id]"
                    [keyword]="searchKeyword"
                    [data]="pipelineItem">
                <app-simple-table
                        (click)="$event.stopPropagation()"
                        [searchKeyword]="searchKeyword"
                        [tableData]="pipelineItem"
                        (settingsClicked$)="openInputParamModal(Primarytemplat,$event)"
                        (openInputParamModalBeforeAdd$)="openInputParamModal(Primarytemplat,$event, true)"
                        (add$)="addPipelineItemToPipeline($event)"
                ></app-simple-table>
            </app-accordian>
        </div>

    </div>
    <div class="pipeline-wrapper" style="overflow-y: auto;height: calc(100% - 56px);">
        <h4 class="heading p-2 m-1 px-0 m-0" style="background-color: #fafafa">
            Bot Intelligence Pipeline ({{pipeLine && pipeLine.length}})
        </h4>
        <div class="flex-grow-1" style="width: 100%">
            <div cdkDropList (cdkDropListDropped)="drop($event)">
                <div *ngFor="let aiModule of pipeLine;let targetIndexNew = index"
                     cdkDrag
                     (mouseenter)="aiModule.pipeLineSrc = 'assets/img/pipeline-hover-drag.svg'"
                     (mouseleave)="aiModule.pipeLineSrc = 'assets/img/pipeline-no-hover-drag.svg'"
                     style="padding: 8px"
                     class="mr-3 module-box" [ngClass]="{'border-custom-top':targetIndexNew ===0}">
                    <img [src]="aiModule.pipeLineSrc ||pipeLineSrc"
                         style="margin-right: 8px" alt="">
                    <div class="d-flex flex-column">
                        <ng-container
                                *ngIf="(aiModule.id| pipeineIdToPipelineModuleWrapper) as pipelineModuleWrapper; else pipelineModuleWrapperNotFound">
                            <span class="module">{{pipelineModuleWrapper.display_values}}</span>
                            <span class="library">{{(aiModule.id|pipelineIdToPipelineModule)?.library}}</span>
                        </ng-container>

                        <ng-template #pipelineModuleWrapperNotFound>
                            <span class="module">id: <i>{{aiModule.id}}</i> (Not found)</span>
                        </ng-template>
                    </div>
                    <span class="ml-auto"></span>
                    <i *ngIf="aiModule && aiModule.input_params && myObject.keys(aiModule.input_params).length>0"
                       (click)="openInputParamModal(Primarytemplat,aiModule);"
                       class="fa fa-cog">
                    </i>
                    <i class="fa fa-minus-circle show-on-parent-hover" style="color: #b14250"
                       (click)="removePipelineItemFromPipelineModal(targetIndexNew,aiModule.id)"></i>
                </div>
            </div>
        </div>
    </div>
</section>

<div *ngIf="!pipelineModulesV2List"
     style="position: absolute; top: 0; left: 0;right: 0; bottom: 0; display: flex; justify-content: center; align-items: center">
    You don't have access to pipelines.
</div>

<ng-template #Primarytemplat>
  <div class="primary-modal" style = "width:430px">
    <div class="modal-header pb-1">
      <h4 class="modal-title" style="display: flex;justify-content: start;">{{selectedPipeline.unique_name}}</h4>
      <button type="button" class="close pull-right" aria-label="Close" (click)="dialogRefWrapper.ref.close()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div class="modal-body pt-0">
      <form ngNativeValidate class="d-flex flex-column" #Pipelineform="ngForm">
        <div class="pb-2">Library configuration</div>
        <div *ngFor="let Key of myObject.keys(selectedPipeline.display_values)" >

             <mat-form-field *ngIf="selectedPipeline.display_values[Key].type == 'dropdown'">
              <mat-select [placeholder]="selectedPipeline.display_values[Key].display_value" name="{{Key}}"
              [ngModel]="selectedPipeline.input_params[Key] || selectedPipeline.display_values[Key].default">
                    <mat-option *ngFor="let dropi of selectedPipeline.display_values[Key].content | convertToUniqueArray" [value]="dropi"  >
                      {{dropi}}
                </mat-option>
              </mat-select>
            </mat-form-field>
          <!-- <div class=""
               *ngIf="selectedPipeline.display_values[Key].type == 'dropdown'">

            <label class="mb-0  w-50 "
                   style="text-align: left;">{{selectedPipeline.display_values[Key].display_value}}</label>
            <select class="w-50" style="color: #474747;"
                    [ngModel]="selectedPipeline.input_params[Key] || selectedPipeline.display_values[Key].default"
                    name="{{Key}}">
              <option *ngFor="let dropi of selectedPipeline.display_values[Key].content"
                      type="button" [value]="dropi">{{dropi}}
              </option>
            </select>
          </div> -->
          <mat-form-field *ngIf="selectedPipeline.display_values[Key].type == 'text'" >
            <input matInput [placeholder]="selectedPipeline.display_values[Key].display_value"
            [ngModel]="selectedPipeline.input_params[Key]" name="{{Key}}">
          </mat-form-field>
          <!-- <div *ngIf="selectedPipeline.display_values[Key].type == 'text'">
            <label class="mb-0 w-50"
                   style="text-align: left;">{{selectedPipeline.display_values[Key].display_value}}</label>
            <input type="text" class="input-material flex-grow-1 w-50" style="color: #474747;"
                   [ngModel]="selectedPipeline.input_params[Key]"
                   name="{{Key}}">
          </div> -->

        </div>
        <div class = "ml-auto">
            <button class="btn-theme btn-theme-primary-outline mr-1"
            (click)="dialogRefWrapper.ref.close()">Cancel</button>

          <button class="btn-theme btn-theme-success-sm"
            (click)="submitPipeline(Pipelineform); dialogRefWrapper.ref.close(true)">Add&nbsp;>>
          </button>
        </div>

      </form>
    </div>
    </div>
</ng-template>
