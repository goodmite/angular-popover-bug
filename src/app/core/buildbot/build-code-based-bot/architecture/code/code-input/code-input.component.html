<div class="p-1 d-flex-column-last-child-flex-grow-1">
  <app-code-version-list
    [selectedVersion]="selectedVersion_st"
    [versionDiffs]="diff$|async"
    [activeVersion]="activeVersion"
    (activateVersion$)="activateVersion($event)"
    [bot]="bot"
    [versions]="versions_st"
    (changeSelectedVersion$)="changeSelectedVersionHandler($event)"
    (saveSelectedVersion$)="saveSelectedVersion()"
    (downloadAll$)="downloadZipHandler()"
    (openForkNewVersionModal$)="openForkNewVersionModal(forkVersionTemplate)"
  ></app-code-version-list>

  <form [formGroup]="codeInputForm" class="row" style="margin-bottom: 10px; flex-grow: 1; position: relative">
    <button class="mat-theme-button mat-theme-button-border to-code-view px-1"
            *ngIf="activeTab === myEBotVersionTabs.generation_templates && permanentlyShowUIViewFormBackend && showGenTempEditor" 
            (click)="openEditCodeModal(selectedVersion_st)" mat-button>
        Edit code
      </button>
      <span style="position: absolute;z-index: 10;right: 0;top: 5px;color:#474747;display: flex;align-items: center;"
        *ngIf="activeTab === myEBotVersionTabs.generation_templates && permanentlyShowUIViewFormBackend">
          Code<mat-slide-toggle 
          [checked]="!showGenTempEditor"
          (change)="viewChanged($event.checked)"
          class="d-flex align-items-center mx-1 " color="primary"
          title="Toggle UI view"></mat-slide-toggle>Interface
      </span>
    <!-- <mat-slide-toggle style="position: absolute; z-index: 10000000;right: 0;top: 5px;"
                      [checked]="!showGenTempEditor"
                      *ngIf="activeTab === myEBotVersionTabs.generation_templates && permanentlyShowUIViewFormBackend" (change)="viewChanged($event.checked)"
                      class="d-flex align-items-center mx-1 " color="primary"
                      title="Toggle UI view"></mat-slide-toggle> -->
    <mat-tab-group
      animationDuration="0ms"
      *ngIf="errorMap[selectedVersion_st.id] && errorMap[selectedVersion_st.id] || {} as errorMapItem"
      style="width: 100%; position: relative" (selectedIndexChange)="codeEditorTabChangedHandler($event)">
      <mat-tab>
        <ng-template mat-tab-label>
          <span>DF Template</span>
          <mat-icon *ngIf="errorMapItem?.df_template?.error" class="error-indication">error_outline</mat-icon>
        </ng-template>
        <div class="d-flex" style="height: 100%">
          <app-code-editor class="child-expand"
                           [formControlName]="myEBotVersionTabs.df_template"
                           (validateClick)="validateCodeTest($event)"
                           downloadedFileName="{{activeTab}} for bot id {{bot.id}}.py"
                           [doShowValidationsIcon]="true"
          ></app-code-editor>
          <ng-container
            [ngTemplateOutlet]="validationTemplate"
            [ngTemplateOutletContext]="{activeTabName: activeTab}">
          </ng-container>
        </div>

      </mat-tab>
      <mat-tab>
        <ng-template mat-tab-label>
          <span>DF Rules</span>
          <mat-icon *ngIf="errorMapItem?.df_rules?.error" class="error-indication">error_outline</mat-icon>
        </ng-template>
        <div class="d-flex" style="height: 100%">
          <app-code-editor [formControlName]="myEBotVersionTabs.df_rules"
                           [doShowValidationsIcon]="true"
                           downloadedFileName="{{activeTab}} for bot id {{bot.id}}.py"
                           (validateClick)="validateCodeTest($event)"></app-code-editor>
          <ng-container
            [ngTemplateOutlet]="validationTemplate"
            [ngTemplateOutletContext]="{activeTabName: activeTab}">
          </ng-container>
        </div>
      </mat-tab>
      <mat-tab>
        <ng-template mat-tab-label>
          <span>Generation Rules</span>
          <mat-icon *ngIf="errorMapItem?.generation_rules?.error" class="error-indication">error_outline</mat-icon>
        </ng-template>
        <div class="d-flex" style="height: 100%">
          <app-code-editor [doShowValidationsIcon]="true"
                           downloadedFileName="{{activeTab}} for bot id {{bot.id}}.py"
                           [formControlName]="myEBotVersionTabs.generation_rules"
                           (validateClick)="validateCodeTest($event)"></app-code-editor>
          <ng-container
            [ngTemplateOutlet]="validationTemplate"
            [ngTemplateOutletContext]="{activeTabName: activeTab}">
          </ng-container>
        </div>
      </mat-tab>
      <mat-tab>
        <ng-template mat-tab-label>
          <span>Generation Template</span>
          <mat-icon *ngIf="errorMapItem?.generation_templates?.error" class="error-indication">error_outline</mat-icon>
        </ng-template>
        <div class="d-flex" style="height: 100%" *ngIf="showGenTempEditor">
          <app-code-editor
            [formControlName]="myEBotVersionTabs.generation_templates"
            [doShowValidationsIcon]="true"
            downloadedFileName="{{activeTab}} for bot id {{bot.id}}.py"
            (validateClick)="validateCodeTest($event)"
            [readOnly] = "false"
            *ngIf="!permanentlyShowUIViewFormBackend"
            >
          </app-code-editor>
          <app-code-editor
            [formControlName]="myEBotVersionTabs.generation_templates"
            [doShowValidationsIcon]="true"
            downloadedFileName="{{activeTab}} for bot id {{bot.id}}.py"
            (validateClick)="validateCodeTest($event)"
            [readOnly] = "true"
            *ngIf="permanentlyShowUIViewFormBackend"
            >
          </app-code-editor>
          <ng-container
            [ngTemplateOutlet]="validationTemplate"
            [ngTemplateOutletContext]="{activeTabName: activeTab}">
          </ng-container>
        </div>
        <!--start:: gentemplate UI-->
        <ng-container *ngIf="!showGenTempEditor">
          <app-code-gentemplate-ui-wrapper
            style="height: 100%"
            *ngIf="isGentemplateCodeParsable; else cantParseGenTemplateCodeTemplate"
            class="row mx-0 px-0 child-expand"
            [activeTab]="activeTab"
            [channelList]="channelListClone"
            [bot]="bot"
            [templateKeyDict]="templateKeyDict"
            (convertUiDictToGenTemplateCode$)="convertUiDictToGenTemplateCode($event)">
          </app-code-gentemplate-ui-wrapper>
        </ng-container>
        <!--end:: gentemplate UI-->

      </mat-tab>
      <mat-tab>
        <ng-template mat-tab-label>
          <span>Workflows</span>
          <mat-icon *ngIf="errorMapItem?.workflow?.error" class="error-indication">error_outline</mat-icon>
        </ng-template>
        <div class="d-flex" style="height: 100%">
          <app-code-editor
            [formControlName]="myEBotVersionTabs.workflow"
            [doShowValidationsIcon]="true"
            downloadedFileName="{{activeTab}} for bot id {{bot.id}}.py"
            (validateClick)="validateCodeTest($event)"></app-code-editor>
          <ng-container
            [ngTemplateOutlet]="validationTemplate"
            [ngTemplateOutletContext]="{activeTabName: activeTab}">
          </ng-container>
        </div>
      </mat-tab>
    </mat-tab-group>
  </form>


  <!--validation start here-->
  <ng-template #validationTemplate let-activeTabName="activeTabName">
    <!--<i>{{validation[selectedVersion_st.id]|json}}</i>}}-->
    <ng-container>
      <div class="d-flex" style="height:100%"
           *ngIf="(errorMap && errorMap[selectedVersion_st?.id] && errorMap[selectedVersion_st?.id][activeTabName] || {}) as errorObj">
        <div
          class="code-editor-row code-editor-row-max position-relative child-expand  d-flex-column-last-child-flex-grow-1">
        </div>
        <div class="validation-bar">
          <div class="dot-indicator">
            <i class="fa fa-check-circle color-primary" *ngIf="!errorObj?.error"></i>
            <i class="fa fa-exclamation-triangle color-danger"
               *ngIf="!!errorObj?.error"></i>

          </div>
          <div class="validation-toggle cursor-pointer" (click)="validationMessageToggle = !validationMessageToggle">
            <i class="fa fa-angle-double-right" *ngIf='validationMessageToggle'></i>
            <i class="fa fa-angle-double-left" *ngIf='!validationMessageToggle'></i>
          </div>
        </div>
        <div class="validation-message"
             *ngIf="validationMessageToggle">
          <div class="validation-message-heading" *ngIf="!!errorObj?.error">
            Issue found
          </div>
          <div class="validation-message-heading" *ngIf="!errorObj?.error">
            No issue found
          </div>
          <div class="validation-message-data my-1" *ngIf="!!errorObj?.error">
            Error = {{ errorObj.error_msg}} <br>
            Value = {{ errorObj.error_line}} <br>
          </div>
          <div class="validation-message-data my-1" *ngIf="!errorObj?.error">
            Validation was successful. You can validate again if you need.
          </div>
        </div>

      </div>
    </ng-container>
  </ng-template>
  <!--validation end here-->

  <!--modals starts-->
</div>
<ng-template #ForkVersiontemplate>
  <div class="primary-modal" style="width: 500px;">
    <div class="modal-header" style="display: block!important;">
      <div class="d-flex">
        <h4 class="modal-title mb-2">Fork to a new version</h4>
        <button type="button" class="close pull-right" aria-label="Close"
                (click)="dialogRefWrapper.ref.close()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <p class="pb-20">By default it will be saved and not be activated.</p>
    </div>

    <div class="modal-body">
      <form class="d-flex flex-column" #fork_new_version_form="ngForm" style="align-items: start;">
        <div class="d-flex" style="align-items: center;">
          <div class="mr-4">
            <label for="">Fork from</label>
          </div>
          <mat-form-field style="width: 46px;">
            <mat-select placeholder="Version" [ngModel]="selectedVersion_st.version" required type="number"
                        name="version_id" #select>
              <mat-option *ngFor="let version of versions_st" [value]="version.version">
                {{version.version}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <mat-form-field class="example-full-width" style="width: 85%;">
          <input matInput placeholder="Comments on the new version" ngModel
                 required
                 name="comment">
        </mat-form-field>

        <div class="ml-auto pt-4">
          <p *ngIf="errorMessage" class="text-danger">{{errorMessage}}</p>

          <button class="btn-theme btn-theme-primary-outline mr-1"
                  (click)="dialogRefWrapper.ref.close()">Cancel
          </button>

          <button [disabled]="!fork_new_version_form.valid" class="btn-theme btn-theme-primary"
                  (click)="forkNewVersion(fork_new_version_form.value)">
            Fork new version
          </button>
        </div>

      </form>
    </div>
  </div>
</ng-template>
<ng-template #cantParseGenTemplateCodeTemplate>
  <div class="d-flex justify-content-center align-items-center"
       style="position:absolute; left: 0; right: 0; bottom: 0;top: 0">
    <i>Can't parse Gentemplate code</i>
  </div>
</ng-template>
