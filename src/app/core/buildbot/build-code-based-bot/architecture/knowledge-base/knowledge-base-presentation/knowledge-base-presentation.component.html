<form [formGroup]="form" class="d-flex-column-last-child-flex-grow-1 create-concept-row" style="padding-left: 14px">

  <header>
    <div style="position: relative;padding-bottom: 16px">
      <span data-cy="back" class="fa fa-angle-left back-icon" title="Go back" (click)="goBack()"></span>
      <h6 style="font-size: 16px; font-weight: bold; margin-bottom: 8px">{{ner_id ? "Edit" : "Create" }} Concept</h6>
      <p style="color: #696969; font-size: 11px">Select from 5 concept types. ‘Single match’ which matches the phrase
        exactly said; ‘Partial Match’ which matches within a subset of the string;‘Regex’ to parse regular expressions;
        ‘Database’ for multiple values; ‘With metadata’ for additional accesible data.</p>
    </div>
  </header>

  <div class="child d-flex justify-content-between" style="margin-bottom: 0.7em">

    <div class="options d-flex align-items-end w-100">
      <mat-form-field style="margin-bottom: -1.25em">
        <input type="text" matInput
               [disabled]="disableAll"
               data-cy="concept-name-input"
               placeholder="Concept name" required  formControlName="key">
        <mat-error class="mat-error-small" *ngIf="form.get('key').errors?.error as errorObj">{{errorObj.message}}</mat-error>
      </mat-form-field>
      <div class="d-flex flex-column mx-2">
        <mat-form-field style="margin-bottom: -1.25em">
          <mat-select
                      [disabled]="disableAll"
                      required formControlName="ner_type" placeholder="Concept Type">
            <mat-option value="single_match">Single Match</mat-option>
            <mat-option value="double_match">Double Match</mat-option>
            <mat-option value="with_metadata">With Metadata</mat-option>
            <mat-option value="database">Database</mat-option>
            <mat-option value="regex">Regex</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="d-flex flex-column mx-2">
        <label class="m-0 p-0 mb-1">Process Raw Text</label>
        <div style="height: 26px;">
          <mat-slide-toggle
            [disabled]="disableAll"
            formControlName="process_raw_text"
            color="primary"
            class="d-flex align-items-center mx-1"
            style="border:none;padding: 0;"
            ></mat-slide-toggle>
        </div>
      </div>

      <div class="d-flex flex-column mx-2" *ngIf="form.value.ner_type==='single_match' ||form.value.ner_type==='double_match' ||form.value.ner_type==='regex';">
        <label class="m-0 p-0 mb-1">Mask concept value</label>
        <div style="height: 26px;">
          <mat-slide-toggle
            [disabled]="disableAll"
            formControlName="is_sensitive"
            color="primary"
            class="d-flex align-items-center mx-1"
            style="border:none;padding: 0;"
            ></mat-slide-toggle>
        </div>
      </div>


      <div class="d-flex flex-column mx-2" *ngIf="form.value.ner_type==='single_match';">
        <label class="m-0 p-0 mb-1">Ignore punctuations</label>
        <div style="height: 26px;">
          <mat-slide-toggle
            [disabled]="disableAll"
            formControlName="ignore_punctuation"
            color="primary"
            class="d-flex align-items-center mx-1"
            style="border:none;padding: 0;"
            ></mat-slide-toggle>
        </div>
      </div>

      <div class="d-flex flex-column mx-2 mr-auto" *ngIf="routeName!==myERouteNames['Get Enterprise Knowledge base']">
        <span class="required p-0 mb-1 ">Override Policy</span>
        <div class="d-flex cursor-pointer" style="height: 26px;">
          <label
            [ngClass]="{'label-selected':conflict_policy==='override','label-unselected': conflict_policy==='merge'}"
            class="p-0 px-2 m-0"
            for="radio1">Override</label>
          <input hidden type="radio" class="form-check-input" id="radio1" required formControlName="conflict_policy"
                  value="override" checked>
          <label
            [ngClass]="{'label-unselected':conflict_policy==='override','label-selected': conflict_policy==='merge'}"
            class="p-0 px-2 m-0" for="radio2">Merge</label>
          <input hidden type="radio" class="form-check-input" id="radio2" required formControlName="conflict_policy"
                  value="merge">

        </div>

      </div>

      <div *ngIf="routeName===myERouteNames['Get Enterprise Knowledge base']" class="ml-auto" style="display:flex;" >

        <button mat-flat-button
                class="mat-theme-button"
                style="border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 2px; margin-right: 10px;margin-left: 10px;padding-left:5px; padding-right:10px;"
                data-cy="concept-cancel"
                (click)="goBackWithoutModal()">
          <mat-icon>cancel</mat-icon>
          Cancel
        </button>

       <button mat-flat-button
                color="primary"
                class="mat-theme-button"
                data-cy="concept-create"
                style="border: 1px solid rgba(0, 0, 0, 0.12); border-radius: 2px; margin-right: 10px;padding-left:5px; padding-right:10px;"
                [disabled]="!form.valid || (ner_type === 'database' && !handsOnTableDataHasAtleastTwoRows())"
                (click)="updateOrSaveConcept()"
                *appMyIf="[myEAllActions['Create Enterprise Knowledge base'],myEAllActions['Update Enterprise Knowledge base']]"
        >
          <mat-icon>{{ner_id?'update':'add'}}</mat-icon>
          {{ner_id ? "Update" : "Create" }}
        </button>





      </div>

      <div *ngIf="routeName!==myERouteNames['Get Enterprise Knowledge base']" style="display:flex;">
       <button mat-flat-button
                class="mat-theme-button"
                data-cy="concept-cancel"
                style="border: 1px solid rgba(0, 0, 0, 0.12);border-radius: 2px; margin-right: 10px; margin-left: 10px; padding-left:5px; padding-right:10px; "
                (click)="goBackWithoutModal()">
          <mat-icon>cancel</mat-icon>
          Cancel
        </button>

      <button mat-flat-button
                color="primary"
                class="mat-theme-button"
                data-cy="concept-create"
                style="margin-right: 10px;
                padding-left:5px; padding-right:10px;"
                [disabled]="!form.valid"
                (click)="updateOrSaveConcept()"
                *appMyIf="[myEAllActions['Create Bot Knowledge base'],myEAllActions['Update Bot Knowledge base']]">
          <mat-icon>update</mat-icon>
          {{ner_id ? "Update" : "Create" }}
        </button>
      </div>

      <ng-container
        *appMyIf="myEAllActions['Delete Enterprise Knowledge base']">
        <div *ngIf="ner_id && routeName===myERouteNames['Get Enterprise Knowledge base']">
          <button mat-button
                  class="mat-theme-button"
                  style="border: 1px solid rgba(0, 0, 0, 0.12); border-radius: 2px; margin-right: 10px; padding-left:5px; padding-right:5px;"
                  data-cy="concept-delete"
                  [disabled]="!form.valid"
                  (click)="openDeleteModal(deleteTemplate)">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </ng-container>

      <ng-container *appMyIf="myEAllActions['Delete Bot Knowledge base']">
        <div *ngIf="ner_id && routeName!==myERouteNames['Get Enterprise Knowledge base']">
          <button mat-button
                  class="mat-theme-button"
                  data-cy="concept-delete"
                  style="min-width: 16px!important; padding: 0"
                  [disabled]="!form.valid"
                  (click)="openDeleteModal(deleteTemplate)">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </ng-container>
    </div>
  </div>

  <div class="mt-2 d-flex-column-last-child-flex-grow-1 child">
    <div class="d-flex-column-last-child-flex-grow-1"
         *ngIf="form.value.ner_type==='single_match' ||form.value.ner_type==='double_match' ||form.value.ner_type==='with_metadata' ||form.value.ner_type==='regex';">
      <app-code-editor
                       [readOnly]="disableAll"
                       formControlName="code"
                       ></app-code-editor>
    </div>
    <app-handsontable
      *ngIf="form.value.ner_type==='database'"
      class="d-flex-column-last-child-flex-grow-1"
      style="overflow: auto;"
      [testData]="handsontableData"
      (csvUploaded$)="handsontableData = $event"
      [setting]="constantsService.HANDSON_TABLE_KNOWLEDGE_BASE_SETTING">
    </app-handsontable>
  </div>
</form>

<ng-template #deleteTemplate>
  <div class="danger-modal">
    <div class="modal-header">
      <h4 class="modal-title mb-2" style="display: flex;justify-content: start;">Delete Concept?</h4>
      <button type="button" class="close pull-right" aria-label="Close" (click)="dialogRefWrapper.ref.close()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div class="modal-body pt-0">
      <form #form="ngForm">
        <div class="text-center my-1">
          <p class="mb-3">This action cannot be undone.Are you sure you wish to delete?</p>
        </div>
        <button class="btn-theme btn-theme-secondary-outline mr-2" (click)="dialogRefWrapper.ref.close()">
          Cancel
        </button>
        <button class=" btn-theme btn-theme-danger"
                (click)="deleteNer$.emit(ner_id);dialogRefWrapper.ref.close()">Delete
        </button>
      </form>
    </div>
  </div>
</ng-template>

