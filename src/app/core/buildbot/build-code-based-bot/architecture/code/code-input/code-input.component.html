<!--<p>{{selectedVersion.generation_templates|json}}</p>-->
<!--<p>{{editorCodeObj.generation_templates|json}}</p>-->
<div class="p-1 d-flex-column-last-child-flex-grow-1">
  <app-code-version-list
    [selectedVersion]="selectedVersion"
    [activeVersion]="activeVersion"
    [bot]="bot"
    (changeSelectedVersion$)="changeSelectedVersion($event)"
    (saveSelectedVersion$)="saveSelectedVersion(validationWarningModal)"
    (openForkNewVersionModal$)="openForkNewVersionModal(Primarytemplate)"
  ></app-code-version-list>

  <div class="row row-tabs child-no-expand-shrink ">
    <div class="col-12">
      <div class="card ">

        <!--tabs start-->
        <div class="card-body p-0 mr-0">
          <ul class="nav nav-tabs theme-tabbing">
            <li class="nav-item" [ngClass]="{'tab-active': activeTab===myEBotVersionTabs.df_template}">
              <i class="fa fa-exclamation-triangle color-danger"
                 *ngIf="!!selectedVersion.validation[myEBotVersionTabs.df_template].error"></i>
              <a class="nav-link text-theme-normal d-inline-block" (click)="tabClicked(myEBotVersionTabs.df_template)">DF
                Template</a>
            </li>
            <li class="nav-item" [ngClass]="{'tab-active': activeTab===myEBotVersionTabs.df_rules}">
              <i class="fa fa-exclamation-triangle color-danger"
                 *ngIf="!!selectedVersion.validation[myEBotVersionTabs.df_rules].error"></i>
              <a class="nav-link text-theme-normal d-inline-block" (click)="tabClicked(myEBotVersionTabs.df_rules)">DF
                Rules</a>
            </li>
            <li class="nav-item text-theme-normal"
                [ngClass]="{'tab-active': activeTab===myEBotVersionTabs.generation_rules}">
              <i class="fa fa-exclamation-triangle color-danger"
                 *ngIf="!!selectedVersion.validation[myEBotVersionTabs.generation_rules].error"></i>
              <a class="nav-link d-inline-block" (click)="tabClicked(myEBotVersionTabs.generation_rules)">Generation
                Rules</a>
            </li>
            <li class="nav-item text-theme-normal"
                [ngClass]="{'tab-active': activeTab===myEBotVersionTabs.generation_templates}">
              <i class="fa fa-exclamation-triangle color-danger"
                 *ngIf="!!selectedVersion.validation[myEBotVersionTabs.generation_templates].error"></i>
              <a class="nav-link d-inline-block" (click)="tabClicked(myEBotVersionTabs.generation_templates)">Generation
                Template</a>
            </li>
            <li class="nav-item text-theme-normal" [ngClass]="{'tab-active': activeTab===myEBotVersionTabs.workflow}">
              <i class="fa fa-exclamation-triangle color-danger"
                 *ngIf="!!selectedVersion.validation[myEBotVersionTabs.workflow].error"></i>
              <a class="nav-link d-inline-block" (click)="tabClicked(myEBotVersionTabs.workflow)">Workflows</a>
            </li>
            <li>
              <!--<button [hidden]="activeTab!==myEBotVersionTabs.generation_templates" (click)="showGenTempUi = !showGenTempUi; convertUiDictToGenTemplateCode()">button123-->
              <!--</button>-->
            <li class="ml-auto gen-templet-toggle d-flex align-items-center"
                *ngIf="activeTab===myEBotVersionTabs.generation_templates">
              <!-- <button [hidden]="activeTab!==myEBotVersionTabs.generation_templates" (click)="showGenTempUi = !showGenTempUi">button</button> -->
              <span>Interface</span>
              <ui-switch *ngIf="showViewChangeToggle" color="rgb(0, 34, 64)"
                         switchColor="white" name="toggle_gen_templet"
                         (change)="viewChanged($event)"
                         [(ngModel)]="showGenTempEditorAndHideGenTempUi"
                         class="d-flex align-items-center mx-1 "
                         style="border:none;padding: 0;"
                         size="small" title="Toggle UI view"></ui-switch>
              <span>Code</span>

            </li>
          </ul>
          <!--tabs end-->

        </div>
      </div>
    </div>
  </div>
  <!-- code editor starts here -->
  <div class="d-flex" style="height:100%">
    <div
      class="code-editor-row code-editor-row-max position-relative child-expand  d-flex-column-last-child-flex-grow-1">

      <app-code-editor class="child-expand" [hidden]="activeTab!==myEBotVersionTabs.df_template"
                       [text]="editorCodeObj[myEBotVersionTabs.df_template]"
                       (textChangedEvent)="saveText($event)"
                       (validateClick)="validateCodeTest($event)"></app-code-editor>

      <app-code-editor [hidden]="activeTab!==myEBotVersionTabs.df_rules"
                       [text]="editorCodeObj[myEBotVersionTabs.df_rules]"
                       (textChangedEvent)="saveText($event)"
                       (validateClick)="validateCodeTest($event)"></app-code-editor>

      <app-code-editor [hidden]="activeTab!==myEBotVersionTabs.generation_rules"
                       [text]="editorCodeObj[myEBotVersionTabs.generation_rules]"
                       (textChangedEvent)="saveText($event)"
                       (validateClick)="validateCodeTest($event)"></app-code-editor>
      <!--generation template UI starts-->
      <!--<p>{{templateKeyDict|json}}</p>-->
      <!--<p>{{selectedVersion|json}}</p>-->
      <ng-container *ngIf="isGentemplateCodeParsable; else cantParseGenTemplateCodeTemplate">
        <app-code-gentemplate-ui-wrapper
          *ngIf="activeTab===myEBotVersionTabs.generation_templates && buildTab==='code' && !showGenTempEditorAndHideGenTempUi"
          class="row mx-0 px-0 child-expand"
          [activeTab]="activeTab"
          [channelList]="channelListClone"
          [bot]="bot"
          [selectedTemplateKeyOutputIndex]="selectedTemplateKeyOutputIndex"
          [templateKeyDict]="templateKeyDict"
          (convertUiDictToGenTemplateCode$)="convertUiDictToGenTemplateCode($event)"
        ></app-code-gentemplate-ui-wrapper>
      </ng-container>
      <!--generation template UI ends-->

      <ng-template #cantParseGenTemplateCodeTemplate>
        <div  class="d-flex justify-content-center align-items-center" style="position:absolute; left: 0; right: 0; bottom: 0;top: 0">
          <i>Can't parse gentemplate code</i>
        </div>
      </ng-template>

      <app-code-editor *ngIf="activeTab===myEBotVersionTabs.generation_templates && showGenTempEditorAndHideGenTempUi"
                       [text]="editorCodeObj[myEBotVersionTabs.generation_templates]"
                       (textChangedEvent)="saveText($event)"
                       (validateClick)="validateCodeTest($event)">
      </app-code-editor>

      <app-code-editor [hidden]="activeTab!==myEBotVersionTabs.workflow "
                       [text]="editorCodeObj[myEBotVersionTabs.workflow]"
                       (textChangedEvent)="saveText($event)"
                       (validateClick)="validateCodeTest($event)"></app-code-editor>
    </div>
    <div class="validation-bar" *ngIf="activeTab!==myEBotVersionTabs.generation_templates || showGenTempEditorAndHideGenTempUi">
      <div class="dot-indicator">
        <i class="fa fa-check-circle color-primary" *ngIf="!selectedVersion.validation[activeTab].error"></i>
        <i class="fa fa-exclamation-triangle color-danger" *ngIf="!!selectedVersion.validation[activeTab].error"></i>

      </div>
      <div class="validation-toggle cursor-pointer" (click)="validationMessageToggle = !validationMessageToggle">
        <i class="fa fa-angle-double-right" *ngIf='validationMessageToggle'></i>
        <i class="fa fa-angle-double-left" *ngIf='!validationMessageToggle'></i>
      </div>
    </div>
    <div class="validation-message" *ngIf="validationMessageToggle">
      <div class="validation-message-heading" *ngIf="!!selectedVersion.validation[activeTab].error">
        Issue found
      </div>
      <div class="validation-message-heading" *ngIf="!selectedVersion.validation[activeTab].error">
        No issue found
      </div>
      <div class="validation-message-data my-1" *ngIf="!!selectedVersion.validation[activeTab].error">
        Error = {{ selectedVersion.validation[activeTab].error_msg}} <br>
        Value = {{ selectedVersion.validation[activeTab].error_line}} <br>
      </div>
      <div class="validation-message-data my-1" *ngIf="!selectedVersion.validation[activeTab].error">
        Validation was successful. You can validate again if you need.
      </div>
    </div>
  </div>

</div>

<!--modals starts-->
<ng-template #Primarytemplate>
  <div class="primary-modal">
    <div class="top-dec"></div>
    <div class="modal-header" style="display: block!important;">
      <div class="d-flex">
        <h4 class="modal-title mb-2"> Fork to a new version</h4>
        <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <p>By default it will be saved and not be made active. You need to update changes to make it active.</p>

    </div>

    <div class="modal-body">
      <form class="row" #fork_new_version_form="ngForm">

        <div class="col-md-3 d-flex justify-content-end">
          <label for="">Fork from</label>
        </div>
        <div class="col-md-9 px-0 d-flex justify-content-start">
          <!--<input type="password" [(ngModel)]="forked_From" name="old_password">-->
          <!--<select class="concept1" [(ngModel)]="forked_version_number" required type="number" name="version_id" #select>-->
          <!--<option type="button" *ngFor="let version of bot.store_bot_versions">-->
          <!--<button>{{version.version}}</button>-->
          <!--</option>-->
          <!--</select>-->

          <!--<div class="form-group m-0 mr-4 ml-auto">-->
          <select class="concept1" [(ngModel)]="forked_version_number" required type="number" name="version_id" #select>
            <img style="height: 20px; width: 20px; position: absolute;left: 5px"
                 src="https://s3-eu-west-1.amazonaws.com/imibot-dev/integrations/facebook.png"
                 alt="">
            <option type="button" *ngFor="let version of bot.store_bot_versions">
              <button>{{version.version}}</button>
            </option>
          </select>
          <!--</div>-->

        </div>
        <div class="col-md-3 my-2">
          <label for="">Comments on the new version</label>
        </div>
        <div class="col-md-9 px-0 d-flex justify-content-start my-2">
          <textarea type="text" style="width: 100%" [(ngModel)]="forked_comments" name="comment"></textarea>
        </div>
        <div class="col-md-12">
          <p *ngIf="errorMessage" class="text-danger">{{errorMessage}}</p>
          <button class="btn-theme btn-theme-primary-outline mr-1" (click)="modalRef.hide()">Cancel</button>

          <button class="btn-theme btn-theme-primary" (click)="forkNewVersion()">
            Fork
          </button>
        </div>

      </form>
    </div>
  </div>
</ng-template>


<ng-template #IntentSelectionModal>
  <div class="primary-modal">
    <div class="top-dec"></div>
    <div class="modal-header" style="border: none !important;">
      <h4 class="modal-title" style="display: flex;justify-content: start;">Copy response templates to</h4>
      <button aria-label="Close" class="close pull-right" type="button" (click)="modalRef.hide()"><span
        aria-hidden="true">×</span>
      </button>
      <br>
    </div>
    <div class="d-flex w-100 col-12" style="align-items: center;padding-left: 27px;">
      <div>{{(modelGenTempNameForm.value|numberOfTrueKeys)||"No"}} response selected</div>
      <div class="cursor-pointer color-primary ml-3" (click)="modelGenTempNameForm.reset()">
        Clear
      </div>
      <div class="cursor-pointer color-primary ml-auto mr-3"
           (click)="selectAllCheckBoxesInCopyTemplateForm(modelGenTempNameForm)">
        Select all
      </div>
      <div>
        <input type="text" style="width: 120px;border: 1px solid #e0e0e0;margin-right: 60px; padding: 3px"
               [(ngModel)]="copyModalTemplateSearchKeyword">
      </div>
    </div>
    <div class="modal-body" style="padding-top: 10px!important;">
      <div class="d-flex flex-column align-items-center justify-content-center m-2" id="checkboxes">

        <form class="modelGridGenTempNames" id="modelGenTempNameForm" #modelGenTempNameForm="ngForm"
              (submit)="selectedListCopy(modelGenTempNameForm)">
          <label class="container-chekbox text-dark"
                 *ngFor="let templateKey of myObject.keys(templateKeyDict)|filterTemplateLeyList:copyModalTemplateSearchKeyword">{{templateKey}}
            <input type="checkbox" ngModel name="{{templateKey}}">
            <span class="checkmark"></span>
          </label>
        </form>
        <div class="d-flex w-100">
          <button class="btn-theme btn-theme-primary-outline ml-auto mr-2" (click)="modalRef.hide()">Cancel</button>
          <button class="btn-theme btn-theme-primary  d-inline-block mr-2"
                  [disabled]="(modelGenTempNameForm.value|numberOfTrueKeys)<1"
                  form="modelGenTempNameForm">Copy
            now
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-template>


<ng-template #validationWarningModal>
  <div class="danger-modal">
    <div class="top-dec"></div>
    <div class="modal-header" style="border:none !important">
      <h4 class="modal-title mb-2" style="display: flex;justify-content: start;">version save failed</h4>
      <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div class="mx-3 mb-3" style="text-align: left !important;">
      <form #form="ngForm">
        <div class="my-1">
          <p class="mb-3">the current active version has error which need to be rectified before saving the version.
            You can resolve the errors in the active version to save it right now.
          </p>
          <p>
            You can fork this version to an inactive version with these errors and you can save it,
            inactive versions can be saved with errors.
          </p>
        </div>
        <div class="d-flex">
          <!-- <button class="btn-theme btn-theme-secondary-outline mr-2" (click)="modalRef.hide()">Cancel</button> -->
          <button class=" btn-theme btn-theme-primary-outline " style="color:#474747"
                  (click)="modalRef.hide();openForkNewVersionModal(Primarytemplate)">Fork an inactive version
          </button>
        </div>
      </form>
    </div>
  </div>
</ng-template>


